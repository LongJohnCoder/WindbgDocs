<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 3.2 Final//EN"><HTML DIR="LTR" xmlns:MSHelp="http://msdn.microsoft.com/MSHelp">
<HEAD>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<TITLE>Controlling Threads and Processes</TITLE>
<META NAME="ms.locale" content="en-us">
<META NAME="DESCRIPTION" CONTENT="Debugger, Debugger, Design Guide, Controlling Threads and Processes"><xml><MSHelp:Keyword Index="A" Term="Engine_DG_1442c778-acca-4b77-a596-6863ab5c8279.xml"/>
<META NAME="MS-HKWD" CONTENT="Debugger Engine API, threads and processes"></xml><LINK REL="stylesheet" type="text/css" href="backsdk4.css"><SCRIPT src="langref.js"></SCRIPT><style>dd {margin-bottom:0em; margin-left:1.9em; }</style>
<style>.divclass {behavior:url(#default#savehistory);}</style>
<META NAME="save" CONTENT="history">
</HEAD>
<Body topmargin="0">
<DIV STYLE="display:none;"></DIV>
<DIV STYLE="display:none;"></DIV>
<TABLE CLASS="buttonbarshade" CELLSPACING="0" border="0"><TR><TD NOWRAP="true"> </TD></TR></TABLE>
<TABLE CLASS="buttonbartable" CELLSPACING="0">
<TR ID="hdr">
<TD NOWRAP="true" CLASS="runninghead">Debugging Tools for Windows</TD>
</TR>
</TABLE>
<H1><A NAME="Engine_DG_1442c778-acca-4b77-a596-6863ab5c8279.xml"></A>Controlling Threads and Processes</H1>
<P>For an overview of threads and processes in the debugger engine, see <a href="engine_overview_89c9fa4e-c2fe-4ba7-84d5-b049cebd3130.xml.htm">Threads and Processes</a>.</P>
<P>When an <a href="dbg_glossary_c8f901be-266c-4f04-9680-7b04c121f308.xml.htm#5fd797d1-51e0-444c-bc98-94c230c53a52">event</a> occurs, the <a href="dbg_glossary_c8f901be-266c-4f04-9680-7b04c121f308.xml.htm#e61456d2-3bac-4156-9a64-7093e642c95d">event thread</a> and <a href="dbg_glossary_c8f901be-266c-4f04-9680-7b04c121f308.xml.htm#2b2e563b-fb4f-400e-835f-b883e485b0b3">event process</a> are set to the thread and process (operating system or virtual) in which the event occurred.  They can be found using <a href="idebugsystemobjects_2074b9ad-a761-42fd-93ed-4774c2ddf3a5.xml.htm"><b>GetEventThread</b></a> and <a href="idebugsystemobjects_04f445d4-e407-4e0c-bd1b-9570ed4f0433.xml.htm"><b>GetEventProcess</b></a>, respectively.</P>
<H4>Implicit Threads and Processes</H4>
<P>In kernel-mode debugging the debugger engine will use the <i>implicit process</i> to determine which virtual address space to use when performing virtual to physical address translation &#8212; for example, in the methods <a href="idebugdataspaces_56267474-49c4-446c-83eb-3e4eb2e92734.xml.htm"><b>VirtualToPhysical</b></a> and <a href="idebugdataspaces_8f9b4f7a-04c6-4775-9d15-a4e1c56ca48c.xml.htm"><b>ReadVirtual</b></a>.  When an event occurs, the implicit process is set to the current process.</P>
<P>The implicit process may be changed by using <a href="idebugsystemobjects_10effa04-b87c-4555-9860-c2d5057a2529.xml.htm"><b>SetImplicitProcessDataOffset</b></a>.  To determine the implicit process use <a href="idebugsystemobjects_3ec83d96-a7ff-4767-be21-b822c45ae01e.xml.htm"><b>GetImplicitProcessDataOffset</b></a>.</P>
<P class="note"><b>Note</b>  When setting <a href="dbg_glossary_68c9117f-3b66-4505-b633-9f0fd8c1a981.xml.htm#0b1614a6-b26e-4079-8a25-381977fa2c44">breakpoints</a> during a live kernel debugging session, the debugger engine will pass the virtual address of the breakpoint to the target, and the target will set the breakpoint.  In this case, only the process context of the target is used when handling the breakpoint; the value of the implicit process is irrelevant.</P>
<P>In kernel-mode debugging, the debugger engine will use the <i>implicit thread</i> to determine some of the target's <a href="dbg_glossary_67e8768c-0585-41a5-ab7c-f8d2b5978663.xml.htm#14df9d28-2548-44c6-b68f-410607212d6c">registers</a>.  This includes the processor stack (see <a href="idebugregisters_40c9da48-e41f-4890-ace2-b15a2e1cc4ba.xml.htm"><b>GetStackOffset</b></a>), the frame offset (see <a href="idebugregisters_c3f31f5b-76d4-4910-b1a1-f3050c20e815.xml.htm"><b>GetFrameOffset</b></a>), and the instruction offset (see <a href="idebugregisters_229180dd-2da4-4ff1-9284-520bef0b6843.xml.htm"><b>GetInstructionOffset</b></a>).  When an event occurs, the implicit thread is set to the current thread.</P>
<P>The implicit thread may be changed by using <a href="idebugsystemobjects_d78e5ee9-b18c-47a0-9987-41923aaa1aaf.xml.htm"><b>SetImplicitThreadDataOffset</b></a>.  To determine the implicit thread, use <a href="idebugsystemobjects_fd957a10-62ec-464c-b5d0-c1b36a13013f.xml.htm"><b>GetImplicitThreadDataOffset</b></a>.</P>
<P>Not all registers are determined by the implicit thread.  Some registers will remain the same when the implicit thread is changed.</P>
<P class="note"><b>Warning</b>  The implicit process and implicit thread are independent.  If the implicit thread does not belong to the implicit process, then user and session state for the implicit thread will be in the wrong virtual address space and attempts to access this information will cause errors or provide incorrect results.  This problem does not occur when accessing kernel memory, since kernel memory addresses are constant across all virtual address spaces.  Thus information for the implicit thread located in kernel memory may be accessed independent of the implicit process.</P>
<H4>Threads</H4>
<P>The <i>engine thread ID</i> is used by the debugger engine to identify each operating system thread and each <a href="dbg_glossary_70b9b003-ee7a-401b-b0e3-bd8d3f9c3250.xml.htm#7fa3d938-d090-42d1-b248-63d8e65760a6">virtual thread</a> for a target.</P>
<P>While a target is stopped, each thread also has an index relative to the process to which it belongs.  For any process, the index of the first thread in the process is zero, and the index of the last thread is the number of threads in the process minus one.  The number of threads in the current process can be found by using <a href="idebugsystemobjects_47d86764-4881-4178-97fa-d6c8732dbb1a.xml.htm"><b>GetNumberThreads</b></a>.  The total number of threads in all processes in the current target can be found by using <a href="idebugsystemobjects_fece8f3e-8d85-492a-b1f8-beadc398613e.xml.htm"><b>GetTotalNumberThreads</b></a>. </P>
<P>The engine thread ID and system thread ID for one or more threads in the current process can be found from their index by using <a href="idebugsystemobjects_fa12ac17-9a66-45c0-9c91-11236a4a3eab.xml.htm"><b>GetThreadIdsByIndex</b></a>.</P>
<P>The engine maintains several pieces of information about each thread.  This information may be queried for the <a href="dbg_glossary_b06af58a-5ee8-44e1-855d-951cac7e4969.xml.htm#e79fad75-e3ff-41d6-9f36-896e7b1ce5bb">current thread</a>, and may be used to find the engine thread ID for a thread.</P>
<DL><DT>system thread ID <i>(user-mode debugging only)</i>.</DT>
<DD>The system thread ID of the current thread can be found by using <a href="idebugsystemobjects_67dfdace-712e-4652-96bd-d4f073c2bf0f.xml.htm"><b>GetCurrentThreadSystemId</b></a>.  For a given system thread ID, the corresponding engine thread ID may be found by using <a href="idebugsystemobjects_d9c3c65f-9078-4be8-b301-dddc789cd8b0.xml.htm"><b>GetThreadIdBySystemId</b></a>.</DD>
<DT>thread environment block (TEB)</DT>
<DD>The address of the TEB for the current thread can be found by using <a href="idebugsystemobjects_d496c1cf-524f-469f-9cb6-1476f972ae9a.xml.htm"><b>GetCurrentThreadTeb</b></a>.  For a given TEB address, the corresponding engine thread ID may be found by using <a href="idebugsystemobjects_6f4062c3-c2ef-43bf-81c6-32103f37e793.xml.htm"><b>GetThreadIdByTeb</b></a>.  In kernel-mode debugging, the TEB of a (virtual) thread is the TEB of the system thread that was running on the corresponding processor when the last event occurred.</DD>
<DT>data offset</DT>
<DD>In user-mode debugging, the data offset of a (system) thread is the location of the TEB for that thread.  In kernel-mode debugging the data offset of a (virtual) thread is the KTHREAD structure for the system thread that was running on the corresponding processor when the last event occurred.  The data offset of the current thread can be found by using <a href="idebugsystemobjects_5d09a9f7-d6a3-49ed-b872-1b9ee5173d28.xml.htm"><b>GetCurrentThreadDataOffset</b></a>.  For a given data offset, the corresponding engine thread ID may be found by using <a href="idebugsystemobjects_bb1b0f35-219b-4883-8df7-d90a96441720.xml.htm"><b>GetThreadIdByDataOffset</b></a>.</DD>
<DT>system handle</DT>
<DD>The system handle of the current thread can be found by using <a href="idebugsystemobjects_6c615962-bf20-4cdb-8bab-8afc142e8c65.xml.htm"><b>GetCurrentThreadHandle</b></a>.  For a given system handle, the corresponding engine thread ID may be found by using <a href="idebugsystemobjects_d1cb023a-dd00-42bf-9827-e2ee98878964.xml.htm"><b>GetThreadIdByHandle</b></a>.  In kernel-mode debugging, an artificial handle is created for each (virtual) process.  This handle can only be used with debugger engine API queries.</DD>
</DL>
<H4>Processes</H4>
<P>The <i>engine process ID</i> is used by the debugger engine to identify each operating system process and each <a href="dbg_glossary_70b9b003-ee7a-401b-b0e3-bd8d3f9c3250.xml.htm#29bd5b67-5855-469b-a8d6-822d65629990">virtual process</a> for a target.</P>
<P>While a target is stopped, each process has an index relative to the target.  The index of the first process in the target is zero, and the index of the last process is the number of processes in the target minus one.  The number of processes in the current target can be found by using <a href="idebugsystemobjects_28914631-9658-462c-8234-f48bb85efdf6.xml.htm"><b>GetNumberProcesses</b></a>.</P>
<P>The engine process ID and system process ID for one or more threads in the current target can be found from their index by using <a href="idebugsystemobjects_45309dcc-89bd-44a1-bafa-baabd10d54b0.xml.htm"><b>GetProcessIdsByIndex</b></a>.</P>
<P>The engine maintains several pieces of information about each process.  This information may be queried for the <a href="dbg_glossary_b06af58a-5ee8-44e1-855d-951cac7e4969.xml.htm#30992da8-a386-4161-aca9-e9323245eabe">current process</a>, and may be used to find the engine process ID for a process.</P>
<DL><DT>system process ID <i>(user-mode debugging only)</i>.</DT>
<DD>The system process ID of the current process can be found by using <a href="idebugsystemobjects_e2d8479b-c723-462c-b423-905186bf69e6.xml.htm"><b>GetCurrentProcessSystemId</b></a>.  For a given system process ID, the corresponding engine process ID may be found by using <a href="idebugsystemobjects_45c888bc-6771-4cd4-843e-aeafd8c6c6cb.xml.htm"><b>GetProcessIdBySystemId</b></a>.</DD>
<DT>process environment block (PEB)</DT>
<DD>The address of the PEB for the current process can be found by using <a href="idebugsystemobjects_fd672d78-9254-4f24-9f10-99a91d825f2e.xml.htm"><b>GetCurrentProcessPeb</b></a>.  For a given PEB address, the corresponding engine process ID may be found by using <a href="idebugsystemobjects_f5f2396d-d537-40a0-987d-314a9dfb01ff.xml.htm"><b>GetProcessIdByPeb</b></a>.  In kernel-mode debugging, the PEB of the (virtual) process is the PEB of the system process that was running when the last event occurred.</DD>
<DT>data offset</DT>
<DD>In user-mode debugging, the data offset of a (system) process is the location of the PEB of that process.  In kernel-mode debugging, the data offset of the (virtual) process is the KPROCESS structure for the system process that was running when the last event occurred.  The data offset of the current process can be found by using <a href="idebugsystemobjects_f3602018-7f0a-45eb-aadc-26e0f7349737.xml.htm"><b>GetCurrentProcessDataOffset</b></a>.  For a given data offset, the corresponding engine process ID may be found by using <a href="idebugsystemobjects_8c7f276b-9a12-41ac-8c56-4e37b68d491d.xml.htm"><b>GetProcessIdByDataOffset</b></a>.</DD>
<DT>system handle</DT>
<DD>The system handle of the current process can be found by using <a href="idebugsystemobjects_480199cd-20d9-467c-a5c3-42d221f44509.xml.htm"><b>GetCurrentProcessHandle</b></a>.  For a given system handle, the corresponding engine process ID may be found by using <a href="idebugsystemobjects_92e69c0f-a50c-498b-8352-74f0c28ea0d8.xml.htm"><b>GetProcessIdByHandle</b></a>.  In kernel-mode debugging, an artificial handle is created for the (virtual) process.  This handle can only be used with debugger engine queries.</DD>
</DL>
<H4>Events</H4>
<P>In live user-mode debugging, whenever a thread is created or exits in a target, the create-thread and exit-thread debugging events are generated.  These events result in calls to the <a href="comcallbacks_db1fe5dc-8392-4c79-a1ed-9752170eed3c.xml.htm"><b>IDebugEventCallbacks::CreateThread</b></a> and <a href="comcallbacks_554f76a8-5f15-4bcc-b3ec-070ecc836ba9.xml.htm"><b>IDebugEventCallbacks::ExitThread</b></a> callback methods.</P>
<P>In live user-mode debugging, whenever a process is created or exits in a target, the create-process and exit-process debugging events are generated.  These events result in calls to the <a href="comcallbacks_cd6a97b7-a041-419c-8e64-0aeb6fe7b0c8.xml.htm"><b>IDebugEventCallbacks::CreateProcess</b></a> and <a href="comcallbacks_bcacc47e-294c-4dfa-a38e-2b57f534d415.xml.htm"><b>IDebugEventCallbacks::ExitProcess</b></a> callback methods.</P>
<P>For more information about events, see <a href="engine_dg_d6c1b024-ac66-457c-aaf9-913336fdfce5.xml.htm">Monitoring Events</a>.</P>
<H4>Additional Information</H4>
<P>For more information about threads and processes, including the TEB, KTHREAD, PEB, and KPROCESS structures, see <i>Microsoft Windows Internals</i> by David Solomon and Mark Russinovich.</P>
<DIV style="display:yes"></DIV>
<DIV CLASS="footer"><br><A href="dbglegal.htm">© 2009 Microsoft Corporation</A><br><A href="mailto:windbgfb@microsoft.com?subject=documentation feedback [Debugger]: Controlling Threads and Processes RELEASE: (December 09, 2009)&amp;body=%0A%0APRIVACY STATEMENT%0A%0AThe WDK team uses the feedback submitted to improve the WDK documentation. We do not use your e-mail address for any other purpose. We will remove your e-mail address from our system after the issue you are reporting has been resolved. While we are working to resolve this issue, we may send you an e-mail message to request more information about your feedback. After the issues have been addressed, we may send you an e-mail message to let you know that your feedback has been addressed.%0A%0AFor more information about Microsoft's privacy policy, see http://privacy.microsoft.com/en-us/default.aspx.
              ">Send feedback on this topic</A><br>Debugging Tools for Windows<br>December 09, 2009<br></DIV>
</Body>
</HTML>
